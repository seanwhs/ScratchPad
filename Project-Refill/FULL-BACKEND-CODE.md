# Backend Code

The code adheres to the system's philosophy: the backend is the "guardian of physical inventory and financial truth," enforcing the "Triangle of Constraints" (Field-First Operation, Transactional Integrity, Zero-Trust Traceability). It includes:

- **Offline support**: Accepts `client_temp_id` for reconciliation.
- **Atomicity**: All critical operations use `@transaction.atomic` and row-locking (`select_for_update`).
- **Auditability**: Every state change logs to an immutable `AuditLog`.
- **API Design**: Intent-based (e.g., `/confirm/` endpoints), resource-oriented, with Swagger docs via drf-spectacular.
- **Security**: JWT auth, role-based access (Admin, Driver, Supervisor).
- **Output**: PDF invoices via WeasyPrint, email via SMTP.

### Project Structure
The code is organized as follows (you can create this directory structure locally):

```
hsh_lpg_system/
├── core/
│   ├── __init__.py
│   ├── asgi.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── accounts/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations/  # (generated by makemigrations)
│   ├── models.py
│   ├── serializers.py
│   ├── tests.py
│   └── views.py  # (minimal, as auth is handled by SimpleJWT)
├── depots/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations/
│   ├── models.py
│   ├── serializers.py
│   └── views.py
├── equipment/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations/
│   ├── models.py
│   ├── serializers.py
│   └── views.py
├── inventory/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations/
│   ├── models.py
│   ├── serializers.py
│   ├── services.py
│   └── views.py
├── distribution/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations/
│   ├── models.py
│   ├── serializers.py
│   ├── services.py
│   └── views.py
├── customers/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations/
│   ├── models.py
│   ├── serializers.py
│   └── views.py
├── transactions/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations/
│   ├── models.py
│   ├── serializers.py
│   ├── services.py
│   └── views.py
├── invoices/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations/
│   ├── models.py
│   ├── serializers.py
│   ├── services.py
│   └── views.py
├── audit/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations/
│   ├── models.py
│   ├── serializers.py
│   ├── services.py
│   └── views.py
├── middleware/
│   ├── __init__.py
│   ├── apps.py
│   └── request_logging.py
├── utils/
│   ├── __init__.py
│   └── utils.py
├── templates/  # For PDF rendering (WeasyPrint)
│   └── invoice_template.html
├── manage.py
├── requirements.txt
└── .env
```

### Setup Instructions
1. Create the directory structure above.
2. Copy the code into the respective files.
3. Install dependencies: `pip install -r requirements.txt`.
4. Configure `.env` (see sample below).
5. Run migrations: `python manage.py makemigrations && python manage.py migrate`.
6. Create superuser: `python manage.py createsuperuser`.
7. Run server: `python manage.py runserver`.
8. Access Swagger docs: `http://127.0.0.1:8000/api/schema/swagger-ui/`.
9. For PDF generation on Windows, ensure GTK3 is installed and update `manage.py` as per the addendum in "Backend-Tutorial.md".

### .env (Sample)
```
SECRET_KEY=django-insecure-your-secret-key-here
DEBUG=True
DB_ENGINE=mysql  # or sqlite
DB_NAME=hsh_lpg
DB_USER=hsh_user
DB_PASSWORD=hsh_pass
DB_HOST=127.0.0.1
DB_PORT=3306
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your_gmail@gmail.com
EMAIL_HOST_PASSWORD=your_app_password
```

### requirements.txt
```
Django==6.0.1
asgiref==3.11.0
djangorestframework==3.16.1
djangorestframework-simplejwt==5.5.1
drf-spectacular==0.29.0
inflection==0.5.1
django-cors-headers==4.9.0
python-decouple==3.8
mysqlclient==2.2.7
sqlparse==0.5.5
weasyprint==68.0
pydyf==0.12.1
tinycss2==1.5.1
cssselect2==0.8.0
tinyhtml5==2.0.0
fonttools==4.61.1
pyphen==0.17.2
brotli==1.2.0
zopfli==0.4.0
webencodings==0.5.1
pillow==12.1.0
PyJWT==2.10.1
cffi==2.0.0
pycparser==2.23
jsonschema==4.26.0
jsonschema-specifications==2025.9.1
referencing==0.37.0
rpds-py==0.30.0
attrs==25.4.0
typing_extensions==4.15.0
PyYAML==6.0.3
uritemplate==4.2.0
tzdata==2025.3
```

### manage.py (With WeasyPrint Windows Fix)
```python
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys

def main():
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')

    # FIX FOR WEASYPRINT ON WINDOWS
    if sys.platform == 'win32':
        gtk_path = r'D:\GTK3-Runtime\bin'  # Adjust to your GTK installation path
        if os.path.exists(gtk_path):
            os.add_dll_directory(gtk_path)

    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)

if __name__ == '__main__':
    main()
```

### core/settings.py
```python
from pathlib import Path
from decouple import config
from datetime import timedelta

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = config('SECRET_KEY')
DEBUG = config('DEBUG', default=True, cast=bool)
ALLOWED_HOSTS = ['*']

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'drf_spectacular',
    'corsheaders',
    'accounts',
    'depots',
    'equipment',
    'inventory',
    'distribution',
    'customers',
    'transactions',
    'invoices',
    'audit',
    'middleware',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'middleware.request_logging.APILoggingMiddleware',
]

ROOT_URLCONF = 'core.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'core.wsgi.application'
ASGI_APPLICATION = 'core.asgi.application'

AUTH_USER_MODEL = 'accounts.User'

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ),
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
}

SPECTACULAR_SETTINGS = {
    'TITLE': 'HSH LPG Sales & Logistics API',
    'DESCRIPTION': 'API for LPG distribution, transactions, inventory, and invoices.',
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False,
    'SWAGGER_UI_SETTINGS': {'deepLinking': True},
}

SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(hours=8),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
}

DB_ENGINE = config('DB_ENGINE', default='sqlite')
if DB_ENGINE == 'mysql':
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.mysql',
            'NAME': config('DB_NAME'),
            'USER': config('DB_USER'),
            'PASSWORD': config('DB_PASSWORD'),
            'HOST': config('DB_HOST'),
            'PORT': config('DB_PORT'),
            'OPTIONS': {'init_command': "SET sql_mode='STRICT_TRANS_TABLES'"},
        }
    }
else:
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.sqlite3',
            'NAME': BASE_DIR / 'db.sqlite3',
        }
    }

AUTH_PASSWORD_VALIDATORS = [
    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},
    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},
    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},
    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
]

LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'Asia/Singapore'
USE_I18N = True
USE_TZ = True

STATIC_URL = 'static/'

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

CORS_ALLOW_ALL_ORIGINS = True  # For development; restrict in production

EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = config('EMAIL_HOST', default='smtp.gmail.com')
EMAIL_PORT = config('EMAIL_PORT', default=587, cast=int)
EMAIL_USE_TLS = config('EMAIL_USE_TLS', default=True, cast=bool)
EMAIL_HOST_USER = config('EMAIL_HOST_USER')
EMAIL_HOST_PASSWORD = config('EMAIL_HOST_PASSWORD')
```

### core/urls.py
```python
from django.contrib import admin
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from rest_framework_simplejwt.views import TokenObtainPairView, TokenRefreshView
from depots.views import DepotViewSet
from equipment.views import EquipmentViewSet
from inventory.views import InventoryViewSet
from distribution.views import DistributionViewSet
from customers.views import CustomerViewSet
from transactions.views import TransactionViewSet
from invoices.views import InvoiceViewSet
from audit.views import AuditLogViewSet

router = DefaultRouter()
router.register(r'depots', DepotViewSet, basename='depot')
router.register(r'equipment', EquipmentViewSet, basename='equipment')
router.register(r'inventories', InventoryViewSet, basename='inventory')
router.register(r'distributions', DistributionViewSet, basename='distribution')
router.register(r'customers', CustomerViewSet, basename='customer')
router.register(r'transactions', TransactionViewSet, basename='transaction')
router.register(r'invoices', InvoiceViewSet, basename='invoice')
router.register(r'audit', AuditLogViewSet, basename='audit')

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include(router.urls)),
    path('api/token/', TokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('api/token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    path('api/schema/', include('drf_spectacular.urls')),
]
```

### core/wsgi.py (Standard, no changes)
```python
import os
from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
application = get_wsgi_application()
```

### core/asgi.py (Standard, no changes)
```python
import os
from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
application = get_asgi_application()
```

### accounts/models.py
```python
from django.db import models
from django.contrib.auth.models import AbstractUser

class User(AbstractUser):
    ROLE_CHOICES = (
        ('ADMIN', 'Admin'),
        ('DRIVER', 'Driver'),
        ('SUPERVISOR', 'Supervisor'),
    )
    employee_id = models.CharField(max_length=50, unique=True)
    role = models.CharField(max_length=20, choices=ROLE_CHOICES, default='DRIVER')
    vehicle_no = models.CharField(max_length=20, blank=True, null=True)
```

### accounts/serializers.py
```python
from rest_framework import serializers
from .models import User

class UserSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ['id', 'username', 'employee_id', 'role', 'vehicle_no']
```

### depots/models.py
```python
from django.db import models

class Depot(models.Model):
    name = models.CharField(max_length=100, unique=True)
    location = models.CharField(max_length=200, blank=True)

    def __str__(self):
        return self.name
```

### depots/serializers.py
```python
from rest_framework import serializers
from .models import Depot

class DepotSerializer(serializers.ModelSerializer):
    class Meta:
        model = Depot
        fields = '__all__'
```

### depots/views.py
```python
from rest_framework import viewsets
from rest_framework.permissions import IsAuthenticated
from .models import Depot
from .serializers import DepotSerializer

class DepotViewSet(viewsets.ModelViewSet):
    queryset = Depot.objects.all()
    serializer_class = DepotSerializer
    permission_classes = [IsAuthenticated]
```

### equipment/models.py
```python
from django.db import models

class Equipment(models.Model):
    CATEGORY_CHOICES = (
        ('CYLINDER', 'Cylinder'),
        ('METER', 'Meter'),
        ('REGULATOR', 'Regulator'),
    )
    name = models.CharField(max_length=100, unique=True)
    category = models.CharField(max_length=50, choices=CATEGORY_CHOICES)
    default_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)

    def __str__(self):
        return self.name
```

### equipment/serializers.py
```python
from rest_framework import serializers
from .models import Equipment

class EquipmentSerializer(serializers.ModelSerializer):
    class Meta:
        model = Equipment
        fields = '__all__'
```

### equipment/views.py
```python
from rest_framework import viewsets
from rest_framework.permissions import IsAuthenticated
from .models import Equipment
from .serializers import EquipmentSerializer

class EquipmentViewSet(viewsets.ModelViewSet):
    queryset = Equipment.objects.all()
    serializer_class = EquipmentSerializer
    permission_classes = [IsAuthenticated]
```

### inventory/models.py
```python
from django.db import models

class DepotInventory(models.Model):
    depot = models.ForeignKey('depots.Depot', on_delete=models.CASCADE)
    equipment = models.ForeignKey('equipment.Equipment', on_delete=models.CASCADE)
    quantity = models.IntegerField(default=0)

    class Meta:
        unique_together = ('depot', 'equipment')

    def __str__(self):
        return f"{self.depot} - {self.equipment}: {self.quantity}"

class CustomerSiteInventory(models.Model):
    customer = models.ForeignKey('customers.Customer', on_delete=models.CASCADE)
    equipment = models.ForeignKey('equipment.Equipment', on_delete=models.CASCADE)
    quantity = models.IntegerField(default=0)

    class Meta:
        unique_together = ('customer', 'equipment')

    def __str__(self):
        return f"{self.customer} - {self.equipment}: {self.quantity}"
```

### inventory/serializers.py
```python
from rest_framework import serializers
from .models import DepotInventory, CustomerSiteInventory

class DepotInventorySerializer(serializers.ModelSerializer):
    class Meta:
        model = DepotInventory
        fields = '__all__'

class CustomerSiteInventorySerializer(serializers.ModelSerializer):
    class Meta:
        model = CustomerSiteInventory
        fields = '__all__'
```

### inventory/services.py
```python
from django.db import transaction
from django.db.models import F
from .models import CustomerSiteInventory
from audit.services import log_action

@transaction.atomic
def update_inventory(entity, entity_id, equipment_id, delta, user):
    if entity != 'customer':
        raise ValueError("Only 'customer' entity supported for now")

    from customers.models import Customer
    from equipment.models import Equipment

    customer = Customer.objects.get(id=entity_id)
    equipment = Equipment.objects.get(id=equipment_id)

    inventory, created = CustomerSiteInventory.objects.get_or_create(
        customer=customer,
        equipment=equipment,
        defaults={'quantity': 0}
    )

    inventory.quantity = F('quantity') + delta
    inventory.save(update_fields=['quantity'])

    log_action(user, 'Update', f'{entity.capitalize()}Inventory', inventory.id, {'delta': delta})
    return inventory
```

### inventory/views.py
```python
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework import status
from rest_framework.permissions import IsAuthenticated
from .models import DepotInventory, CustomerSiteInventory
from .serializers import DepotInventorySerializer, CustomerSiteInventorySerializer
from .services import update_inventory

class InventoryViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        if self.request.query_params.get('type') == 'depot':
            return DepotInventory.objects.all()
        return CustomerSiteInventory.objects.all()

    def get_serializer_class(self):
        if self.request.query_params.get('type') == 'depot':
            return DepotInventorySerializer
        return CustomerSiteInventorySerializer

    @action(detail=False, methods=['post'], url_path='update')
    def adjust(self, request):
        try:
            inv = update_inventory(
                request.data['entity'],
                request.data['entity_id'],
                request.data['equipment_id'],
                request.data['delta'],
                request.user
            )
            return Response(CustomerSiteInventorySerializer(inv).data)
        except Exception as e:
            return Response({"detail": str(e)}, status=status.HTTP_400_BAD_REQUEST)
```

### distribution/models.py
```python
from django.db import models

class Distribution(models.Model):
    STATUS_CHOICES = (
        ('PENDING', 'Pending'),
        ('CONFIRMED', 'Confirmed'),
    )
    user = models.ForeignKey('accounts.User', on_delete=models.SET_NULL, null=True)
    distribution_number = models.CharField(max_length=20, unique=True, blank=True)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='PENDING')
    client_temp_id = models.CharField(max_length=50, blank=True, null=True)  # For offline sync
    created_at = models.DateTimeField(auto_now_add=True)
    confirmed_at = models.DateTimeField(null=True, blank=True)

    def __str__(self):
        return self.distribution_number or "Pending"

class DistributionItem(models.Model):
    MOVEMENT_CHOICES = (
        ('COLLECTION', 'Collection'),
        ('EMPTY_RETURN', 'Empty Return'),
    )
    distribution = models.ForeignKey(Distribution, on_delete=models.CASCADE, related_name='items')
    depot = models.ForeignKey('depots.Depot', on_delete=models.PROTECT)
    equipment = models.ForeignKey('equipment.Equipment', on_delete=models.PROTECT)
    quantity = models.PositiveIntegerField()
    movement_type = models.CharField(max_length=20, choices=MOVEMENT_CHOICES)

    def __str__(self):
        return f"{self.depot} - {self.equipment}: {self.quantity} ({self.movement_type})"
```

### distribution/serializers.py
```python
from rest_framework import serializers
from .models import Distribution, DistributionItem

class DistributionItemSerializer(serializers.ModelSerializer):
    class Meta:
        model = DistributionItem
        fields = '__all__'

class DistributionSerializer(serializers.ModelSerializer):
    items = DistributionItemSerializer(many=True, read_only=True)

    class Meta:
        model = Distribution
        fields = '__all__'
```

### distribution/services.py
```python
from django.db import transaction
from django.utils import timezone
from django.db.models import F
from .models import Distribution, DistributionItem
from inventory.models import DepotInventory
from audit.services import log_action
from utils.utils import generate_number

@transaction.atomic
def create_distribution(user, data):
    dist = Distribution.objects.create(
        user=user,
        client_temp_id=data.get('client_temp_id'),
        status='PENDING'
    )

    for item in data['items']:
        depot = DepotInventory.objects.select_for_update().get(
            depot_id=item['depot_id'],
            equipment_id=item['equipment_id']
        )

        DistributionItem.objects.create(
            distribution=dist,
            depot_id=item['depot_id'],
            equipment_id=item['equipment_id'],
            quantity=item['quantity'],
            movement_type=item['movement_type']
        )

    log_action(user, 'Create', 'Distribution', dist.id, data)
    return dist

@transaction.atomic
def confirm_distribution(dist_id, user):
    dist = Distribution.objects.select_for_update().get(id=dist_id)
    if dist.status == 'CONFIRMED':
        raise ValueError("Distribution already confirmed")

    dist.distribution_number = generate_number('DIST')
    dist.status = 'CONFIRMED'
    dist.confirmed_at = timezone.now()
    dist.save(update_fields=['distribution_number', 'status', 'confirmed_at'])

    for item in dist.items.all():
        inventory = DepotInventory.objects.select_for_update().get(
            depot=item.depot,
            equipment=item.equipment
        )
        delta = item.quantity if item.movement_type == 'EMPTY_RETURN' else -item.quantity
        inventory.quantity = F('quantity') + delta
        inventory.save(update_fields=['quantity'])

    log_action(user, 'Confirm', 'Distribution', dist.id, {'items': [i.id for i in dist.items.all()]})
    return dist
```

### distribution/views.py
```python
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework import status
from rest_framework.permissions import IsAuthenticated
from .models import Distribution
from .serializers import DistributionSerializer
from .services import create_distribution, confirm_distribution

class DistributionViewSet(viewsets.ModelViewSet):
    queryset = Distribution.objects.all()
    serializer_class = DistributionSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        return Distribution.objects.filter(user=self.request.user)  # Driver sees own only

    def create(self, request, *args, **kwargs):
        try:
            dist = create_distribution(request.user, request.data)
            return Response(DistributionSerializer(dist).data, status=status.HTTP_201_CREATED)
        except Exception as e:
            return Response({"detail": str(e)}, status=status.HTTP_400_BAD_REQUEST)

    @action(detail=True, methods=['post'], url_path='confirm')
    def confirm(self, request, pk=None):
        try:
            dist = confirm_distribution(pk, request.user)
            return Response(DistributionSerializer(dist).data)
        except ValueError as ve:
            return Response({"detail": str(ve)}, status=status.HTTP_409_CONFLICT)
        except Exception as e:
            return Response({"detail": str(e)}, status=status.HTTP_400_BAD_REQUEST)
```

### customers/models.py
```python
from django.db import models

class Customer(models.Model):
    PAYMENT_TYPE_CHOICES = (
        ('CASH', 'Cash'),
        ('CREDIT', 'Credit'),
        ('MONTHLY', 'Monthly'),
    )
    name = models.CharField(max_length=200)
    customer_id = models.CharField(max_length=50, unique=True)
    email = models.EmailField(blank=True)
    payment_type = models.CharField(max_length=20, choices=PAYMENT_TYPE_CHOICES, default='CASH')
    meter_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    cyl_9kg_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    cyl_127kg_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    cyl_14kg_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    cyl_50kg_pol_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    cyl_50kg_l_rate = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    last_meter_reading = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)

    def __str__(self):
        return self.name
```

### customers/serializers.py
```python
from rest_framework import serializers
from .models import Customer

class CustomerSerializer(serializers.ModelSerializer):
    class Meta:
        model = Customer
        fields = '__all__'
```

### customers/views.py
```python
from rest_framework import viewsets
from rest_framework.permissions import IsAuthenticated
from .models import Customer
from .serializers import CustomerSerializer

class CustomerViewSet(viewsets.ModelViewSet):
    queryset = Customer.objects.all()
    serializer_class = CustomerSerializer
    permission_classes = [IsAuthenticated]
```

### transactions/models.py
```python
from django.db import models

class Transaction(models.Model):
    STATUS_CHOICES = (
        ('PENDING', 'Pending'),
        ('CONFIRMED', 'Confirmed'),
        ('PAID', 'Paid'),
        ('UNPAID', 'Unpaid'),
    )
    user = models.ForeignKey('accounts.User', on_delete=models.SET_NULL, null=True)
    customer = models.ForeignKey('customers.Customer', on_delete=models.PROTECT)
    transaction_number = models.CharField(max_length=20, unique=True, blank=True)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='PENDING')
    client_temp_id = models.CharField(max_length=50, blank=True, null=True)  # For offline sync
    last_meter_reading = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    current_meter_reading = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    total_amount = models.DecimalField(max_digits=12, decimal_places=2, default=0.00)
    created_at = models.DateTimeField(auto_now_add=True)
    confirmed_at = models.DateTimeField(null=True, blank=True)

    def __str__(self):
        return self.transaction_number or "Pending"

class TransactionItem(models.Model):
    ITEM_TYPE_CHOICES = (
        ('DELIVERY', 'Delivery'),
        ('SERVICE', 'Service'),
    )
    transaction = models.ForeignKey(Transaction, on_delete=models.CASCADE, related_name='items')
    equipment = models.ForeignKey('equipment.Equipment', on_delete=models.PROTECT, null=True)
    quantity = models.PositiveIntegerField(default=1)
    rate = models.DecimalField(max_digits=10, decimal_places=2)
    item_type = models.CharField(max_length=20, choices=ITEM_TYPE_CHOICES)

    def __str__(self):
        return f"{self.transaction} - {self.equipment or 'Service'}: {self.quantity}"
```

### transactions/serializers.py
```python
from rest_framework import serializers
from .models import Transaction, TransactionItem

class TransactionItemSerializer(serializers.ModelSerializer):
    class Meta:
        model = TransactionItem
        fields = '__all__'

class TransactionSerializer(serializers.ModelSerializer):
    items = TransactionItemSerializer(many=True, read_only=True)

    class Meta:
        model = Transaction
        fields = '__all__'
```

### transactions/services.py
```python
from django.db import transaction
from django.utils import timezone
from django.conf import settings
from django.core.mail import send_mail
from django.template.loader import render_to_string
from weasyprint import HTML
from .models import Transaction, TransactionItem
from invoices.models import Invoice
from inventory.services import update_inventory
from audit.services import log_action
from utils.utils import generate_number

@transaction.atomic
def create_customer_transaction_and_invoice(user, data):
    from customers.models import Customer
    customer = Customer.objects.get(id=data['customer_id'])

    trx = Transaction.objects.create(
        user=user,
        customer=customer,
        transaction_number=generate_number('TRX'),
        client_temp_id=data.get('client_temp_id'),
        status='CONFIRMED',
        last_meter_reading=customer.last_meter_reading or 0,
        current_meter_reading=data.get('current_meter_reading', 0),
        confirmed_at=timezone.now()
    )

    meter_usage = (trx.current_meter_reading - trx.last_meter_reading) * customer.meter_rate
    total = meter_usage

    for item in data.get('items', []):
        TransactionItem.objects.create(
            transaction=trx,
            equipment_id=item.get('equipment_id'),
            quantity=item['quantity'],
            rate=item['rate'],
            item_type=item['item_type']
        )
        total += item['quantity'] * item['rate']

        # Update customer inventory
        delta = item['quantity'] if item['item_type'] == 'DELIVERY' else 0
        if delta > 0:
            update_inventory('customer', customer.id, item['equipment_id'], delta, user)

    trx.total_amount = total
    trx.save(update_fields=['total_amount'])

    # Create Invoice
    inv = Invoice.objects.create(
        transaction=trx,
        invoice_number=generate_number('INV'),
        pdf_path=''  # To be set after generation
    )

    # Generate PDF
    html = render_to_string('invoice_template.html', {'transaction': trx, 'invoice': inv})
    pdf = HTML(string=html).write_pdf()
    pdf_path = f'invoices/{inv.invoice_number}.pdf'
    with open(pdf_path, 'wb') as f:
        f.write(pdf)
    inv.pdf_path = pdf_path
    inv.save(update_fields=['pdf_path'])

    # Email Invoice (optional)
    if data.get('email_invoice', False):
        send_mail(
            'Your HSH LPG Invoice',
            'Please find attached your invoice.',
            settings.EMAIL_HOST_USER,
            [customer.email],
            fail_silently=False,
            attachments=[(f'{inv.invoice_number}.pdf', pdf, 'application/pdf')]
        )

    # Update customer last_meter_reading
    customer.last_meter_reading = trx.current_meter_reading
    customer.save(update_fields=['last_meter_reading'])

    log_action(user, 'Create', 'Transaction', trx.id, data)
    return trx, inv
```

### transactions/views.py
```python
from rest_framework import viewsets
from rest_framework.response import Response
from rest_framework import status
from rest_framework.permissions import IsAuthenticated
from .models import Transaction
from .serializers import TransactionSerializer
from .services import create_customer_transaction_and_invoice

class TransactionViewSet(viewsets.ModelViewSet):
    queryset = Transaction.objects.all()
    serializer_class = TransactionSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        return Transaction.objects.filter(user=self.request.user)  # Driver sees own only

    def create(self, request, *args, **kwargs):
        try:
            trx, inv = create_customer_transaction_and_invoice(request.user, request.data)
            return Response(TransactionSerializer(trx).data, status=status.HTTP_201_CREATED)
        except Exception as e:
            return Response({"detail": str(e)}, status=status.HTTP_400_BAD_REQUEST)
```

### invoices/models.py
```python
from django.db import models

class Invoice(models.Model):
    transaction = models.OneToOneField('transactions.Transaction', on_delete=models.CASCADE)
    invoice_number = models.CharField(max_length=20, unique=True)
    pdf_path = models.FileField(upload_to='invoices/', blank=True)
    emailed_at = models.DateTimeField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.invoice_number
```

### invoices/serializers.py
```python
from rest_framework import serializers
from .models import Invoice

class InvoiceSerializer(serializers.ModelSerializer):
    class Meta:
        model = Invoice
        fields = '__all__'
```

### invoices/services.py
```python
# (Optional for Phase 2; minimal for MVP)
from django.db import transaction
from django.conf import settings
from django.core.mail import send_mail
from weasyprint import HTML
from django.template.loader import render_to_string
from .models import Invoice

@transaction.atomic
def generate_and_email_invoice(invoice_id):
    invoice = Invoice.objects.get(id=invoice_id)
    trx = invoice.transaction

    # Generate PDF if not exists
    if not invoice.pdf_path:
        html = render_to_string('invoice_template.html', {'transaction': trx, 'invoice': invoice})
        pdf = HTML(string=html).write_pdf()
        pdf_path = f'invoices/{invoice.invoice_number}.pdf'
        with open(pdf_path, 'wb') as f:
            f.write(pdf)
        invoice.pdf_path = pdf_path
        invoice.save(update_fields=['pdf_path'])

    # Email
    send_mail(
        'Your HSH LPG Invoice',
        'Please find attached your invoice.',
        settings.EMAIL_HOST_USER,
        [trx.customer.email],
        fail_silently=False,
        attachments=[(f'{invoice.invoice_number}.pdf', open(invoice.pdf_path, 'rb').read(), 'application/pdf')]
    )
    invoice.emailed_at = timezone.now()
    invoice.save(update_fields=['emailed_at'])
```

### invoices/views.py
```python
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework import status
from rest_framework.permissions import IsAuthenticated
from django.http import FileResponse
from .models import Invoice
from .serializers import InvoiceSerializer
from .services import generate_and_email_invoice

class InvoiceViewSet(viewsets.ModelViewSet):
    queryset = Invoice.objects.all()
    serializer_class = InvoiceSerializer
    permission_classes = [IsAuthenticated]

    @action(detail=True, methods=['get'], url_path='pdf')
    def download_pdf(self, request, pk=None):
        invoice = self.get_object()
        if not invoice.pdf_path:
            return Response({"detail": "PDF not generated"}, status=status.HTTP_404_NOT_FOUND)
        return FileResponse(open(invoice.pdf_path, 'rb'), content_type='application/pdf')

    @action(detail=True, methods=['post'], url_path='email')
    def email_invoice(self, request, pk=None):
        try:
            generate_and_email_invoice(pk)
            return Response({"status": "emailed"})
        except Exception as e:
            return Response({"detail": str(e)}, status=status.HTTP_400_BAD_REQUEST)
```

### audit/models.py
```python
from django.db import models
from django.contrib.postgres.fields import JSONField

class AuditLog(models.Model):
    user = models.ForeignKey('accounts.User', on_delete=models.SET_NULL, null=True)
    action = models.CharField(max_length=50)  # Create, Update, Confirm, etc.
    entity_type = models.CharField(max_length=50)  # Distribution, Transaction, etc.
    entity_id = models.PositiveIntegerField()
    payload = JSONField(default=dict)  # Snapshot of data
    timestamp = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.action} on {self.entity_type} {self.entity_id} by {self.user}"
```

### audit/serializers.py
```python
from rest_framework import serializers
from .models import AuditLog

class AuditLogSerializer(serializers.ModelSerializer):
    class Meta:
        model = AuditLog
        fields = '__all__'
```

### audit/services.py
```python
from .models import AuditLog

def log_action(user, action, entity_type, entity_id, payload):
    AuditLog.objects.create(
        user=user,
        action=action,
        entity_type=entity_type,
        entity_id=entity_id,
        payload=payload
    )
```

### audit/views.py
```python
from rest_framework import viewsets
from rest_framework.permissions import IsAuthenticated
from .models import AuditLog
from .serializers import AuditLogSerializer

class AuditLogViewSet(viewsets.ReadOnlyModelViewSet):
    queryset = AuditLog.objects.all().order_by('-timestamp')
    serializer_class = AuditLogSerializer
    permission_classes = [IsAuthenticated]  # Read-only, even for admins
```

### middleware/request_logging.py
```python
import time
import logging

logger = logging.getLogger(__name__)

class APILoggingMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        start = time.monotonic()
        response = self.get_response(request)
        duration_ms = int((time.monotonic() - start) * 1000)

        if request.path.startswith('/api/'):
            user = request.user.username if request.user.is_authenticated else "Anonymous"
            logger.info(
                "%s %s %s %dms %s",
                request.method, request.path, user, duration_ms,
                request.META.get('REMOTE_ADDR', 'unknown')
            )
        return response
```

### utils/utils.py
```python
from django.utils import timezone

def generate_number(prefix):
    timestamp = timezone.now().strftime('%Y%m%d%H%M%S')
    return f"{prefix}-{timestamp}"
```

### templates/invoice_template.html (For WeasyPrint)
```html
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; }
        .header { text-align: center; margin-bottom: 20px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { border: 1px solid #ddd; padding: 8px; }
        .total { text-align: right; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>HSH LPG Invoice</h1>
        <p>Invoice Number: {{ invoice.invoice_number }}</p>
        <p>Date: {{ transaction.confirmed_at }}</p>
    </div>
    <p>Customer: {{ transaction.customer.name }}</p>
    <table class="table">
        <thead>
            <tr>
                <th>Item</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for item in transaction.items.all %}
            <tr>
                <td>{{ item.equipment.name or 'Service' }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.rate }}</td>
                <td>{{ item.quantity|mul:item.rate }}</td>
            </tr>
            {% endfor %}
            <tr>
                <td colspan="3">Meter Usage</td>
                <td>{{ transaction.current_meter_reading|sub:transaction.last_meter_reading|mul:transaction.customer.meter_rate }}</td>
            </tr>
        </tbody>
    </table>
    <p class="total">Total: {{ transaction.total_amount }}</p>
</body>
</html>
```

